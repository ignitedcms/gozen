<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>Query builder</title>

      <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
      <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>

      <link rel="stylesheet" href="/resources/css/output.css">
      <script src="/resources/js/vue2.js"></script>
      <style>
#draggable-0 { width: 200px; height: 250px; padding: 0.5em; }
#draggable-1 { width: 200px; height: 250px; padding: 0.5em; }
#draggable-2 { width: 200px; height: 250px; padding: 0.5em; }
#draggable-3 { width: 200px; height: 250px; padding: 0.5em; }

.node-left{
   position:absolute;
   height:20px;
   width:20px;
   background-color:#fff;
   left:-30px;
   top:2px;
   border-radius:50px;
   border:solid 2px #038cfc;

}
        .node-right{
           position:absolute;
           height:20px;
           width:20px;
           background-color:#fff;
           right:-30px;
           top:2px;
           border-radius:50px;
           border:solid 2px #038cfc;

        }
        .active {
           background-color: green !important;
        }

        #drawing-area {
           width: 100%;
           border: 1px solid #ccc;
           position: relative;
        }

        .point {
           width: 5px;
           height: 5px;
           background-color: blue;
           position: absolute;
           border-radius: 50%;
           cursor: pointer;
        }
        .line {
           position: absolute;
           background-color: gray;
           transform-origin: 0 0;
        }

      </style>

   </head>
   <body class=" bg-[--light-gray]" >
      <div id="app">

         <div id="drawing-area" ref="drawingArea"  @click="handleClick">
            <div v-for="point in points" :key="point.id" class="point" :style="{ left: point.x + 'px', top: point.y + 'px' }"></div>
            <div v-for="line in lines" :key="line.id" class="line" :style="{ width: line.length + 'px', height: '5px', left: line.x + 'px', top: line.y + 'px', transform: 'rotate(' + line.angle + 'rad)' }"></div>

            <div>
               [[ connection ]]
               <button type="submit" class="border border-black" @click="allowConnection">
                  Create connection
               </button>
            </div>


            <div v-for="(t,index) in foo">
               <div :id="setDraggable(index)" class="bg-white border border-[--gray] rounded-md shadow-md cursor-pointer">
                  <div class="">[[t.Table.Name]]</div>
                  <div class="relative" v-for="(f,index) in foo[index].Columns">
                     <div class="node-left" @click="checkIfGood(t.Table.Name);    setLeft(f.UUID); setJoin(t.Table.Name); setTarget(t.Table.Name,f.Name)"></div>
                     <div class="node-right" @click="checkIfGood(t.Table.Name);   setRight(f.UUID); setFrom(t.Table.Name); setSource(t.Table.Name,f.Name)"></div>
                     <input v-model="items" type="checkbox" :value="setCheckbox(t.Table.Name,f.Name)" class="form-check-input">
                     <label for="the label">[[f.Name]]</label>
                  </div>

               </div>
            </div>

            <div class="mt-4">debug</div>
            left:[[ltable]]
            right:[[rtable]]
            



            <pre class="code mt-4">
SELECT <span>[[selectStatement]] </span> 
FROM [[from]]
INNER JOIN [[join]] ON [[sourceTable]] = [[targetTable]];
            </pre>


         </div>
      </div>
      <script> 
         var app = new Vue(
            {
               el: '#app',
               delimiters: ['[[', ']]'],
               data:{
                  circle:'white',
                  selectedIndex:null,
                  foo:{{.Data}},
                  items:[],
                  source:'',
                  target:'',
                  ltable:'',
                  rtable:'',
                  sourceTable:'',
                  targetTable:'',
                  from:'',
                  join:'',
                  points: [],
                  lines: [],
                  connection:false

               },
               methods:
               {
                  //check if connection is legal
                  checkIfGood(a){

                     x = this.ltable;
                     y = this.rtable;

                     if(a != x && a != y)
                     {
                        alert('ok')
                     }
                     else{
                        alert('failed')
                     }
                  },

                  handleClick(e) {

                     //if(this.connection)
                     //{
                     //   const rect = this.$refs.drawingArea.getBoundingClientRect();
                     //   const x = e.clientX - rect.left;
                     //   const y = e.clientY - rect.top;
                     //   this.points.push({ id: this.points.length, x, y });

                     //   if (this.points.length === 2) {
                     //      this.drawLine(this.points[0], this.points[1]);
                     //      this.points = [];
                     //   }
                     //}
                  },
                  drawLine(point1, point2) {
                     const dx = point2.x - point1.x;
                     const dy = point2.y - point1.y;
                     const length = Math.sqrt(dx * dx + dy * dy);
                     const angle = Math.atan2(dy, dx);

                     this.lines.push({
                        id: this.lines.length,
                        x: point1.x,
                        y: point1.y,
                        length,
                        angle
                     });
                  },
                  allowConnection(){
                     this.connection = !this.connection
                     if(this.connection == false)
                     {
                        this.source = "";
                        this.target = "";
                     }
                  },
                  setFrom(a){
                     this.from = a   
                  },
                  setJoin(a){
                     this.join = a
                  },
                  setDraggable(a){
                     return "draggable-" + a
                  },
                  setCheckbox(a,b){
                     return a + "." + b
                  },
                  setSource(a,b){
                     if (this.connection){
                        this.sourceTable = a + "." + b;
                        this.ltable = a;
                     }
                  },
                  setTarget(a,b){
                     if (this.connection){
                        this.targetTable = a + "." + b;
                        this.rtable = a;
                     }
                  },
                  setRight(id){
                     if(this.connection)
                     {
                        this.source = id;
                     }
                  },
                  setLeft(id){
                     if(this.connection)
                     {
                        this.target = id;
                     }
                  },
                  change()
                  {
                     if(this.circle == 'white')
                     {
                        this.circle = 'green'
                     } 
                     else
                     {
                        this.circle = 'white'
                     }
                  }
               },
               computed: {
                  selectStatement() {
                     return this.items.join(', ');
                  }
               },
               mounted()
               {
               }
            });   
      </script> 
      <script>


         $( function() {
            $( "#draggable-0" ).draggable();
            $( "#draggable-1" ).draggable();
            $( "#draggable-2" ).draggable();
            $( "#draggable-3" ).draggable();
         } );
      </script>

   </body>
</html>
